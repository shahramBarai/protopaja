/* Comment this out to disable prints and save space */
#define BLYNK_PRINT Serial


#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>

#define REELAY_OFF 14
#define REELAY_ON 12
#define REELAY_LED 32
unsigned long time_now = 0;

int flag;
int switch_pressed;
int pinData;
// You should get Auth Token in the Blynk App.
// Go to the Project Settings (nut icon).
char auth[] = "d3HgD61J04xc_v-KnesGmsJR_OZHSMtK";

// Your WiFi credentials.
// Set password to "" for open networks.
char ssid[] = "aalto open";
char pass[] = "";


void setup()
{
  // Debug console
  Serial.begin(9600);

  Blynk.begin(auth, ssid, pass);

  pinMode(REELAY_OFF, OUTPUT);
  pinMode(REELAY_ON, OUTPUT);
  pinMode(REELAY_LED, OUTPUT);
}

void loop()
{
  Blynk.run();
  if ((millis() > time_now + 1000) && switch_pressed == 1){
    RelaySwitch();
  }
  
}

BLYNK_WRITE(V0) // Get and store push button status 
{
    pinData = param.asInt(); // save status
    switch_pressed = 1;
}

void RelaySwitch(){
  if (flag != 1){
    if (pinData == 1){
      digitalWrite(REELAY_ON, HIGH);
      digitalWrite(REELAY_LED, HIGH);
      }
    else{
      digitalWrite(REELAY_OFF, HIGH);
      digitalWrite(REELAY_LED, LOW);
      }
    time_now = millis();
    flag = 1;
  } else{
    if (pinData == 1){
      digitalWrite(REELAY_ON, LOW);
      }
    else{
      digitalWrite(REELAY_OFF, LOW);
      }
    flag = 0;
    switch_pressed = 0;
  }
  
}